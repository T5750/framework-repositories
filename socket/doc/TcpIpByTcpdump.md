## 从tcpdump抓包看TCP/IP协议

### 报文获取
1. 在192.168.100.211机器的6379端口启一个Redis服务
1. 通过tcpdump这个工具来抓取数据包，命令：`tcpdump -w /tmp/logs -i eth1 port 6379 -s0`
1. 在192.168.100.162机器上访问Redis实例192.168.100.211:6379，可以用redis-cli客户端，也可以用telnet，发送一个ping，得到对端回复PONG
1. 停止抓包，用tcpdump读取数据包（`-x`以16进制形式展示）：`tcpdump -r /tmp/logs -n -nn -A -x| vim -`

```
16:00:14.937135 IP 192.168.100.162.56427 > 192.168.100.211.6379: Flags [P.], seq 3741217703:3741217717, ack 647125300, win 16423, length 14
        0x0000:  4500 0036 0685 4000 4006 e976 c0a8 64a2
        0x0010:  c0a8 64d3 dc6b 18eb defe 73a7 2692 5934
        0x0020:  5018 4027 08b9 0000 2a31 0d0a 2434 0d0a
        0x0030:  7069 6e67 0d0a
16:00:14.937473 IP 192.168.100.211.6379 > 192.168.100.162.56427: Flags [P.], seq 1:8, ack 14, win 229, length 7
        0x0000:  4500 002f 41b2 4000 4006 ae50 c0a8 64d3
        0x0010:  c0a8 64a2 18eb dc6b 2692 5934 defe 73b5
        0x0020:  5018 00e5 4ae8 0000 2b50 4f4e 470d 0a
16:00:15.135136 IP 192.168.100.162.56427 > 192.168.100.211.6379: Flags [.], ack 8, win 16421, length 0
        0x0000:  4500 0028 0686 4000 4006 e983 c0a8 64a2
        0x0010:  c0a8 64d3 dc6b 18eb defe 73b5 2692 593b
        0x0020:  5010 4025 5d10 0000 0000 0000 0000
```

### 报文分析

#### IP层解析
![IP-packet-min-min](https://www.wailian.work/images/2019/02/26/IP-packet-min-min.png)

字节值 | 字节含义
---|------
0x4 | IP版本为ipv4
0x5 | 首部长度为5 * 4字节=20B
0x00 | 服务类型，现在基本都置为0
0x0036 | 总长度为3*16+6=54字节，上面所有的长度就是54字节
0x0685 | 标识。同一个数据报的唯一标识。当IP数据报被拆分时，会复制到每一个数据中
0x4000 | 3bit标志 + 13bit片偏移。3bit标志对应R、DF、MF。目前只有后两位有效，DF位：为1表示不分片，为0表示分片。MF：为1表示“更多的片”，为0表示这是最后一片。13bit片位移：本分片在原先数据报文中相对首位的偏移位。（需要再乘以8)
0x40 | 生存时间TTL。IP报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为0时，路由器将该数据报丢弃。TTL字段是由发送端初始设置一个8 bit字段。推荐的初始值由分配数字RFC指定。发送ICMP回显应答时经常把TTL设为最大值255。TTL可以防止数据报陷入路由循环。此处为64
0x06 | 协议类型。指出IP报文携带的数据使用的是哪种协议，以便目的主机的IP层能知道要将数据报上交到哪个进程。TCP的协议号为6，UDP的协议号为17。ICMP的协议号为1，IGMP的协议号为2。该IP报文携带的数据使用TCP协议，得到了验证
0xe976 | 16bit IP首部校验和
0xc0a8 64a2 | 32bit源IP地址
0xc0a8 64d3 | 32bit目的IP地址

#### 传输层解析
本报文携带的数据使用的TCP协议，采用`固定长度(20B) + 可变长度`的形式

![TcpHeaderZh-min-min](https://www.wailian.work/images/2019/02/26/TcpHeaderZh-min-min.jpg)

字节值 | 字节含义
---|------
0xdc6b | 16bit源端口。56427
0x18eb | 16bit目的端口。6379
0xdefe 73a7 | 32bit序列号。3741217703
0x2692 5934 | 32bit确认号。647125300
0x5 | 4bit首部长度，以4byte为单位。共5*4=20字节。因此TCP报文的可选长度为20-20=0
0b000000 | 6bit保留位。目前置为0
0b010010 | 6bit TCP标志位。从左到右依次是紧急URG、确认ACK、推送PSH、复位RST、同步SYN、终止FIN
0x4027 | 滑动窗口大小，滑动窗口即TCP接收缓冲区的大小，用于TCP拥塞控制。16423
0x08b9 | 16bit校验和
0x0000 | 紧急指针。仅在URG=1时才有意义，它指出本报文段中的紧急数据的字节数。当URG=1时，发送方TCP就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据

#### 数据部分解析
ping转换成Redis协议如下：
```
*1\r\n
$4\r\n
ping\r\n
```
对照ascii码表来看，`man 7 ascii`
```
0x2a31         -> *1
0x0d0a         -> \r\n
0x2434         -> $4
0x0d0a         -> \r\n
0x7069 0x6e67  -> ping
0x0d0a         -> \r\n
```
```
2b50 4f4e 470d 0a -> +PONG\r\n
```

#### Tips
No | Action | seq | ack | Data
---|------|----|----|---
1 | Client IP.56427 > Server IP.6379 | defe 73a7(3741217703) | 2692 5934(647125300) | ping
2 | Server IP.6379 > Client IP.56427 | 2692 5934(647125300) | defe 73b5(3741217717) | PONG
3 | Client IP.56427 > Server IP.6379 | defe 73b5(3741217717) | 2692 593b(647125307) | 

## References
- [从tcpdump抓包看TCP/IP协议](https://segmentfault.com/a/1190000015044878)