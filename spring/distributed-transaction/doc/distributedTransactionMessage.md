## 常规MQ队列消息的处理流程和特点

### MQ队列消息模型的特点
1. 消息生产者将消息发送到Queue中，然后消息消费者监听Queue并接收消息；
1. 消息被确认消费以后，就会从Queue中删除，所以消息消费者不会消费到已经被消费的消息；
1. Queue支持存在多个消费者，但是对某一个消息而言，只会有一个消费者成功消费。

### 生产与消费常规流程
![distributedTransactionMq-min](http://www.wailian.work/images/2019/01/23/distributedTransactionMq-min.png)
1. Producer生成消息并发送给MQ（同步、异步）；
1. MQ接收消息并将消息数据持久化到消息存储（持久化操作为可选配置）；
1. MQ向Producer返回消息的接收结果（返回值、异常）；
1. Consumer监听并消费MQ中的消息；
1. Consumer获取到消息后执行业务处理；
1. Consumer对已成功消费的消息向MQ进行ACK确认（确认后的消息将从MQ中删除）。

常用的MQ中间件产品ActiveMQ、RabbitMQ、RocketMQ等基本都是这样的流程，具体实现上有各自的差异。规范协议实现上有JMS、AMQP或自定义规范等。

### 与消息发送一致性流程的对比
1. 常规MQ队列消息的处理流程无法实现消息发送一致性；
1. 投递消息的流程其实就是消息的消费流程，可细化。

### 可靠消息的生产与消费的正向流程
![distributedTransactionQueue-min](https://www.wailian.work/images/2019/01/11/distributedTransactionQueue-min.png)

1. 主动方应用先把消息发给消息中间件，消息状态标记为“待确认”；
2. 消息中间件收到消息后，把消息持久化到消息存储中，但并不向被动方应用投递消息；
3. 消息中间件返回消息持久化结果（成功/失败），主动方应用根据返回结果进行判断如何进行业务操作处理：
    - 失败：放弃业务操作处理，结束（必要时向上层返回失败结果）；
    - 成功：执行业务操作处理；
4. 业务操作完成后，把业务操作结果（成功/失败）发送给消息中间件；
5. 消息中间件收到业务操作结果后，根据业务结果进行处理；
    - 失败：删除消息存储中的消息，结束；
    - 成功：更新消息存储中的消息状态为“待发送（可发送）”；
6. 被动方应用监听并接收“待发送”状态的消息，执行业务处理；
7. 业务处理完成后，向消息中间件发送ACK，确认消息已经收到（消息中间件将从队列中删除该消息）。

### 总结
常规MQ队列消息的处理流程无法实现消息发送一致性，因此直接使用现成的MQ中间件产品无法实现可靠消息最终一致性的分布式事务解决方案。

## 消息重复发送问题与业务接口的幂等性设计

### 消息消费流程的异常处理
![distributedTransactionMessageException-min](http://www.wailian.work/images/2019/01/23/distributedTransactionMessageException-min.png)

- 方法：对于未确认的消息，采用按规则重新投递的方式进行处理。
- 问题：消息的重复发送会导致业务处理接口出现重复调用的问题。

### 消息重复发送的原因
序号 | 原因
---|-------
1 | 被动方应用接收到消息，业务处理完成后应用出问题，消息中间件不知道消息处理结果，会重新投递消息。
2 | 被动方应用接收到消息，业务处理完成后网络出问题，消息中间件收不到消息处理结果，会重新投递消息。
3 | 被动方应用接收到消息，业务处理时间过长，消息中间件因消息超时未确认，会再次投递消息。
4 | 被动方应用接收到消息，业务处理完成，消息中间件问题导致收不到消息处理结果，消息会重新投递。
5 | 被动方应用接收到消息，业务处理完成，消息中间件收到了消息处理结果，但由于消息存储故障导致消息没能成功确认，消息会再次投递。

总结：消息消费过程中产生消息重复发送主要是因为消息接收者成功处理完消息后，消息中间件没能及时更新消息投递状态（也就是消息没能及时ACK确认）导致的。

### 允许消息重复发送的约束条件
约束：被动方应用对于消息的业务处理要实现幂等。

### 业务接口的幂等性设计
- 对于存在同一请求数据会发生重复调用的业务接口，接口的业务逻辑要实现幂等性设计。
- 在实际的业务应用场景中，业务接口的幂等性设计，常结合可查询操作一起使用。
- 场景举例
    - 支付订单创建：商户编号 + 商户订单号 + 订单状态
    - 订单更新处理：平台订单号 + 订单状态
    - 会计系统记账：系统来源 + 请求号

### 消息重复发送限制
极端情况：消息重发也得有次数限制，要不然就变成了死循环。对于超过重发次限制的消息，进入DLQ，等待人工干预或延后定期处理。